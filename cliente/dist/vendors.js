app.service("contratoService",["$http",function(o){this.get=function(e){var t=o.get(uri+"/api/contrato/"+e);return t},this.getByCliente=function(e){var t=o.get(uri+"/api/cliente/"+e+"/contratos");return t},this.getTipoVehiculo=function(e){var t=o.get(uri+"/api/plantilla/"+e+"/tipovehiculo");return t},this.getPorNumeroCto=function(e){var t=o.get(uri+"/api/contrato/"+e+"/tiposervicio");return t}}]),app.service("usuarioService",["$http",function(o){this.get=function(e){var t=o.get(uri+"/api/usuario/"+e);return t},this.put=function(e,t){var n=o.put(uri+"/api/usuario/"+e,t);return n},this.udpatePass=function(e,t){var n=o.put(uri+"/api/usuario/updatePassword/"+e,t);return n},this.cerrarSesion=function(e){var t=o.delete(uri+"/api/usuario/"+e+"/cerrar");return t}}]),app.service("zonaService",["$http",function(o){this.get=function(e){var t=o.get(uri+"/api/zona/"+e);return t},this.getPuntos=function(e){var t=o.get(uri+"/api/zona/"+e+"/puntos");return t},this.getZona=function(e,t){var n=o.get(uri+"/api/zona/"+e+"/"+t);return n}}]),app.controller("homeController",["$scope",function(o){function e(){o.Login=session.getUser()}o.Titulo="BIENVENIDOS",o.Login={};var t=1;o.mostrarOcultarMenu=function(){if(1===t){document.getElementById("cont-menu").className="menuLeft";var o=document.getElementById("contenido");o.classList.remove("contenido-normal"),o.classList.add("contenido-expandido"),t+=1}else{var o=document.getElementById("contenido");o.classList.remove("contenido-expandido"),o.classList.add("contenido-normal"),document.getElementById("cont-menu").className="menuRight",t=1}},o.SetTitulo=function(e){o.Titulo=e},e()}]),app.controller("salirController",["$scope","usuarioService","toaster",function(o,e,t){function n(){var n=e.cerrarSesion(o.$parent.Login.IdUsuario);n.then(function(e){sessionStorage.setItem("usuario",""),sessionStorage.removeItem("usuario"),o.mensaje="Su sesión ha finalizado correctamente",t.pop("success","¡Información!","Su sesión ha terminado."),setTimeout('location.href = "../inicio/index.html#/login"',3e3)},function(o){t.pop("error","¡Error!",o.data.request),console.log("failure loading usuarios",o)})}o.$parent.SetTitulo("CERRANDO SESIÓN"),o.mensaje="Cerrando sesión ....",n()}]),app.controller("serviciosController",["$scope","zonaService","ngTableParams","toaster","contratoService","funcionService",function(o,e,t,n,i,r){function a(){this.coordenadas=null,this.marcador=null}function c(){o.Contrato={TipoServicio:[],Plantilla:[],TipoVehiculo:[]},o.Servicio={Origen:"",Destino:"",ContratoId:0,NumeroContrato:"",Nit:"",Nombre:"",Telefono:"",FechaInicio:"",FechaFin:"",Estado:"",Tipo:{},Responsable:"",Hora:"",Valor:"0",NumHoras:"0",NumPasajeros:"0",ClienteId:o.$parent.Login.ClienteId,ZonaOrigen:"",ZonaDestino:""}}function s(){var e=document.getElementById("txtOrigen");o.AutocompleteOrigen=new google.maps.places.Autocomplete(e,h),o.AutocompleteOrigen.bindTo("bounds",o.mapServicio),o.AutocompleteOrigen.addListener("place_changed",function(){f.close(),o.markerOrigen.setVisible(!1);var e=o.AutocompleteOrigen.getPlace();if(!e.geometry)return void n.pop("error","¡Error!","No pudo resolver la  posición");g(o.mapServicio,e),o.markerOrigen.setIcon("images/origen.png"),o.markerOrigen.setPosition(e.geometry.location),o.markerOrigen.setVisible(!0),o.popup||(o.popup=new google.maps.InfoWindow),console.log(o.markerOrigen);var t="";e.address_components&&(t=[e.address_components[0]&&e.address_components[0].short_name||"",e.address_components[1]&&e.address_components[1].short_name||"",e.address_components[2]&&e.address_components[2].short_name||""].join(" ")),f.setContent("<div><strong>"+e.name+"</strong><br>"+t),f.open(o.mapServicio,o.markerOrigen),C=e.place_id,d(C,I,P,O,T)})}function l(){var e=document.getElementById("txtDestino");o.AutocompleteDestino=new google.maps.places.Autocomplete(e,h),o.AutocompleteDestino.bindTo("bounds",o.mapServicio),o.AutocompleteDestino.addListener("place_changed",function(){f.close(),S.setVisible(!1);var e=o.AutocompleteDestino.getPlace();if(!e.geometry)return void n.pop("error","¡Error!","No pudo resolver la  posición");g(o.mapServicio,e),S.setIcon("images/destino.png"),S.setPosition(e.geometry.location),S.setVisible(!0),o.popup||(o.popup=new google.maps.InfoWindow);var t="";e.address_components&&(t=[e.address_components[0]&&e.address_components[0].short_name||"",e.address_components[1]&&e.address_components[1].short_name||"",e.address_components[2]&&e.address_components[2].short_name||""].join(" ")),f.setContent("<div><strong>"+e.name+"</strong><br>"+t),f.open(o.mapServicio,S),I=e.place_id,d(C,I,P,O,T)})}function p(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};o.Posicion.Latitud=e.coords.latitude,o.Posicion.Longitud=e.coords.longitude;var n=new google.maps.Circle({center:t,radius:e.coords.accuracy});o.AutocompleteOrigen.setBounds(n.getBounds())})}function u(){var e={zoom:16,center:new google.maps.LatLng(o.Posicion.Latitud,o.Posicion.Longitud),mapTypeId:google.maps.MapTypeId.ROADMAP};o.mapServicio=new google.maps.Map(document.getElementById("dvMapaServicio"),e),T.setMap(o.mapServicio),google.maps.event.addListener(o.mapServicio,"click",function(e){var t=e.latLng.lat(),n=e.latLng.lng(),i=new google.maps.LatLng(t,n),r=new google.maps.Marker({position:i,map:o.mapServicio,animation:google.maps.Animation.DROP,title:"Marcador"}),c=new a;c.coordenadas=i,c.marcador=r,o.vecPoligono.push(c),m()}),o.markerOrigen=new google.maps.Marker({map:o.mapServicio}),S=new google.maps.Marker({map:o.mapServicio})}function d(o,e,t,i,r){o&&e&&i.route({origin:{placeId:o},destination:{placeId:e},travelMode:t},function(o,e){e===google.maps.DirectionsStatus.OK?r.setDirections(o):n.pop("error","¡Error!","Error al resolver dirección")})}function g(o,e){e.geometry.viewport?o.fitBounds(e.geometry.viewport):(o.setCenter(e.geometry.location),o.setZoom(17))}function m(){for(var e=[],t=0;t<o.vecPoligono.length;t++)e.push(o.vecPoligono[t].coordenadas);null!==o.poly&&o.poly.setMap(null),o.poly=new google.maps.Polygon({paths:e,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.25}),o.poly.setMap(o.mapServicio)}function v(e){var t=i.getTipoVehiculo(e);t.then(function(e){o.Contrato.TipoVehiculo=e.data},function(o){n.pop("error","¡Error!","Error al cargar tipos de vehículo",0),console.log("Some Error Occured "+JSON.stringify(o))})}o.Zonas=[],o.Zona={},o.Contrato={},o.Contratos=[],o.ContratoSelect={},o.Boton={Cargando:!0},o.$parent.SetTitulo("SOLICITAR SERVICIOS"),o.Servicio={},o.Puntos=[],o.editMode=!1,o.mapServicio,o.markerOrigen=null;var S=null,f=new google.maps.InfoWindow,h={componentRestrictions:{country:"co"}},C=null,I=null,P=google.maps.TravelMode.DRIVING,O=new google.maps.DirectionsService,T=new google.maps.DirectionsRenderer;o.vecPoligono=new Array,o.poly=null,o.tbZona={},o.title="Nuevo Servicio",o.Posicion={Latitud:10.4370725,Longitud:-75.524795},o.$parent.SetTitulo("GESTIÓN DE SERVICIOS"),o.AutocompleteOrigen=null,o.AutocompleteDestino=null,p(),u(),s(),l(),c(),o.eliminarUltimoPunto=function(){o.vecPoligono.length>0&&(o.vecPoligono[o.vecPoligono.length-1].marcador.setMap(null),o.vecPoligono.pop(),m())},o.nuevo=function(){o.editMode=!1,o.title="NUEVA ZONA"},o.get=function(e){o.editMode=!0,o.title="EDITAR ZONA",o.Zona=e,getPuntos(e.znCodigo)},o.BuscarContrato=function(e){o.Servicio.ContratoId=0;var t="";if("COMBO"===e)t=o.ContratoSelect.ctNumeroContrato;else{if(!o.Servicio.NumeroContrato)return void n.pop("info","Estimado usuario(a), por favor ingrese el número de contrato");t=o.Servicio.NumeroContrato}n.pop("wait","Consulta","Consultando informacioón....",0),o.Servicio.Tipo=[];var r=i.getPorNumeroCto(t);r.then(function(e){e.data?(n.clear(),o.Servicio.ContratoId=e.data.IdContrato,o.Servicio.Nombre=e.data.ctContratante,o.Servicio.Nit=e.data.ctNitCliente,o.Servicio.Telefono=e.data.ctTelefono,o.Servicio.FechaFin=new Date(e.data.ctFechaFinal).toLocaleDateString("en-GB"),o.Servicio.FechaInicio=new Date(e.data.ctFechaInicio).toLocaleDateString("en-GB"),o.Servicio.Estado=e.data.ctEstado,o.Contrato.TipoServicio=e.data.TipoServicio,o.Contrato.Plantilla=e.data.Plantilla,0===o.Contrato.TipoServicio&&n.pop("error","No se encontraón servicios asociados a este contrato",0)):n.pop("error","Número de contrato no existe")},function(o){n.pop("error","¡Error!",o,0),console.log("Some Error Occured "+JSON.stringify(o))})},o.TipoServicioCheck=function(e){if(console.log(o.Servicio.Tipo),"SI"===o.Servicio.Tipo.csPlantilla){if(1===o.Servicio.Tipo.csTipoServicioId&&u(),o.titlePlantilla="Plantillas "+o.Servicio.Tipo.csDescripcion,0===o.Contrato.Plantilla.length)return void n.pop("error","¡Error!","No se definieron plantillas para este contrato");var t=r.arrayObjectIndexOf(o.Contrato.Plantilla,o.Servicio.Tipo.csTipoServicioId,"pcTipoServicio");t!==-1&&v(o.Contrato.Plantilla[t].plCodigo)}else o.titlePlantilla="Dispobilidad ",o.VerPlantilla=!1},o.GetContratos=function(){var e=i.getByCliente(o.Servicio.ClienteId);e.then(function(e){o.Contratos=e.data},function(o){n.pop("error","¡Error!","Error al cargar contratos"),console.log("Some Error Occured "+JSON.stringify(o))})},o.GetContratos()}]);